#!/usr/bin/env coffee
# vim:ft=coffee
# -*- mode:coffee -*-

convertChapter = (str) ->
    str.replace /^\[chapter:(.+)\]$/igm, (f, h) ->
        "［＃２字下げ］#{h}［＃「#{h}」は大見出し］"

convertRuby = (str) ->
    str.replace /\[\[rb:([^ \[\]]+) > ([^ \[\]]+)\]\]/ig, (f, b, t) ->
        "｜#{b}《#{t}》"

convertNewpage = (str) ->
    (str.split "[newpage]").join "［＃改ページ］"

SPECIAL_CHARS = [
    ["！？", "<cTatecuYoko:1>!?<cTatecuYoko:>"]
    ["！！", "<cTatecuYoko:1>!!<cTatecuYoko:>"]
    ["？！", "<cTatecuYoko:1>?!<cTatecuYoko:>"]
]

convertMarks = (str) ->
    SPECIAL_CHARS.reduce (prev, current) ->
        prev.replace (new RegExp current[0], "ig"), current[1]
    , str

main = () ->
    input = (require "fs").readFileSync "/dev/stdin", "utf-8"
    process.stdout.write convertRuby convertChapter convertNewpage convertMarks input

main()
